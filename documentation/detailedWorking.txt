1Ô∏è‚É£ Server & Configuration Boot

index.js

Loads environment variables
Starts Express server

Registers routes:
/whatsapp ‚Üí main WhatsApp AI flow
/sms ‚Üí SMS AI flow (text-only)
/webhook ‚Üí Dialogflow webhook flow (secondary)
/stats ‚Üí analytics/logging


2Ô∏è‚É£ Incoming Message

WhatsApp: Twilio ‚Üí /whatsapp
SMS: Twilio ‚Üí /sms

Twilio sends(Example):

For Whatsapp:
{
  "Body": "mujhe bukhar hai",
  "From": "whatsapp:+91...",
  "To": "whatsapp:+14..."
}

or for SMS:
{
  "Body": "what is malaria?",
  "From": "+91...",
  "To": "+91..."
}


3Ô∏è‚É£ Preprocessing

utils/preprocess.js

normalizeWhatsAppNumber() ‚Üí ensures standard WhatsApp format
detectVoiceRequest() ‚Üí checks for keywords like:
voice, bolo, awaaz, sunao, üé§
Removes them from text
Sets wantsVoice = true (WhatsApp only)
SMS messages are always text-only


4Ô∏è‚É£ Medical Gatekeeping

utils/handleNonMedical.js / checkIfMedical()

Uses Gemini to determine if message is health-related

If non-medical:
Sends fixed rejection message
Stops further processing

Ensures:
No off-topic AI usage
Lower Gemini costs
Clear product behavior


5Ô∏è‚É£ Intent + Language Detection

config/dialogflow.js

Dialogflow detects:
Intent (e.g., Symptom Checker, Disease Info)
Language code
Custom Hinglish detector if needed

Output example:
{
  "intent": "Symptom Checker",
  "language": "Hinglish"
}


6Ô∏è‚É£ Disease Memory System

utils/ai.js + Firebase

extractDisease(msg) ‚Üí extracts disease name using Gemini
Fetch last disease from Firebase: users/{phone}/lastDisease

Decide topicForAnswer:
currentDisease ?? lastDisease

Enables follow-ups like:
"iska treatment kya hai?"

Memory updated after each message


7Ô∏è‚É£ AI Response Generation

utils/aiResponse.js

generateReply(msg, intent, topicForAnswer)
Fallback prompt if intent unknown
Normal prompt otherwise

Prompts enforce:
Same language & script
Bullet points only
Max 80 words
No emojis or headings
Route code stays clean, AI logic modular


8Ô∏è‚É£ Response Cleaning

whatsapp.js / sms.js

Removes markdown, emojis, unwanted symbols
Normalizes line breaks and spacing

Trims long replies:
WhatsApp: >1500 chars ‚Üí sliced
SMS: >1500 chars ‚Üí sliced


9Ô∏è‚É£ Memory & Logging

utils/conversation.js

Saves conversation:
User message
Intent
AI reply
Voice/Text flag
Timestamp

Updates memory:
users/{phone}/lastDisease


1Ô∏è‚É£0Ô∏è‚É£ Message Delivery

utils/sendMessage.js

WhatsApp

If wantsVoice:
Sanitize text
gTTS ‚Üí MP3
ffmpeg ‚Üí OGG
Upload to GitHub
Send audio via Twilio
Fallback to text if TTS fails

If text-only:
Sends via Twilio WhatsApp API
SMS
Always text-only

DRY_RUN respected for both WhatsApp & SMS


üîÅ Secondary Flow: /webhook

For Dialogflow-only users
Receives webhook
Detects language
Confirms message is medical
Uses generateAIResponse()
Logs conversation to Firebase
Responds to Dialogflow
Runs independently from WhatsApp/SMS flow






To simulate requests we can use curl

For Whatsapp:

curl -X POST http://localhost:PORT/whatsapp \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "From=whatsapp:+91xxxxxxxxxx" \
  --data-urlencode "To=whatsapp:+1xxxxxxxxxx" \
  --data-urlencode "Body=QUERY"

For Localhost:

curl -X POST http://localhost:PORT/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "queryResult": {
      "queryText": "QUERY",
      "intent": {
        "displayName": "INETENT"
      }
    }
  }'

For SMS:

curl -X POST http://localhost:PORT/sms \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "From=+91XXXXXXXXXX" \
  --data-urlencode "To=+1xxxxxxxxxx" \
  --data-urlencode "Body=QUERY"
